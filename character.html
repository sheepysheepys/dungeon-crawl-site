<!-- Keep your existing markup; here's the script block logic changes -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js';
  const supabase = createClient(
    'https://fqegrllwoskrfcnmzlod.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxZWdybGx3b3NrcmZjbm16bG9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODk1ODEsImV4cCI6MjA3MDA2NTU4MX0.bI0gGkXD8U-C9lhOkWgJ0QN9swx0lLX5rFpVpI_D2DE'
  );

  const userStr = localStorage.getItem('user');
  if (!userStr) window.location.href = 'login.html';
  const user = JSON.parse(userStr);
  if (!user?.id) {
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  }

  // role gate: DMs go to dashboard
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();
  if (profile?.role === 'dm') {
    window.location.href = 'dm-dashboard.html';
  }

  async function loadCharacter() {
    const { data: character, error } = await supabase
      .from('characters')
      .select('*')
      .eq('user_id', user.id)
      .single();

    if (error || !character) {
      window.location.href = 'create-character.html';
      return;
    }

    document.getElementById('character-info').innerHTML = `
      <h2>${character.name}</h2>
      <p>Level: ${character.level}</p>
      <p>HP: ${character.hp_current} / ${character.hp_max}</p>
      <p>Armor: ${character.armor_hp} (${character.armor_state})</p>
      <p>Stripping Stage: ${character.stripping_stage}</p>
    `;
  }

  loadCharacter();

  document.getElementById('logout-btn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  });
</script>
